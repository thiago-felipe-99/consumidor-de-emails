<!DOCTYPE html>
<html>

<head>
  <title>Attachment Upload</title>
</head>

<body>
  <h1>Attachment Upload</h1>
  <form id="upload-form">
    <input type="file" id="file" name="file" onChange="handleFileSelect()">
    <button type="submit">Upload</button>
  </form>

  <button id="button-login">Login</button>

  <script>
    let session = ''

    fetch('http://localhost:8080/user/session', {
      method: 'POST',
      body: JSON.stringify({
        name: 'test',
        password: 'test'
      }),
      headers: {
        'Content-Type': 'application/json',
        'Session': session
      }
    }).then(response => {
      session = response.headers.get('session');
    }).catch(error => {
      console.error(error);
    });

    const button = document.getElementById('button-login');

    button.addEventListener('click', event => {
      fetch('http://localhost:8080/user/session', {
        method: 'POST',
        body: JSON.stringify({
          name: 'test',
          password: 'test'
        }),
        headers: {
          'Content-Type': 'application/json',
          'Session': session
        }
      }).then(response => {
        session = response.headers.get('session');
      }).catch(error => {
        console.error(error);
      });
    });

    async function handleFileSelect() {
      const fileInput = document.getElementById('file');
      const file = fileInput.files[0];

      if (!file) {
        alert('Please select a file to upload.');
        return;
      }

      event.preventDefault();

      try {
        const responseAttachment = await fetch('http://localhost:8080/email/attachment', {
          method: 'POST',
          body: JSON.stringify({
            name: file.name,
            contentType: file.type,
            size: file.size
          }),
          headers: {
            'Content-Type': 'application/json',
            'Session': session
          }
        })

        session = responseAttachment.headers.get('session');

        if (!responseAttachment.ok) {
          console.log(responseAttachment)
          return
        }

        const data = await responseAttachment.json()

        const formData = new FormData();
        Object.entries(data.formData).forEach(([key, value]) => {
          formData.append(key, value);
        });
        formData.append('file', file);

        const responseMinio = await fetch(data.url, {
          method: 'POST',
          body: formData
        });

        if (!responseMinio.ok) {
          console.log(responseMinio)
          return
        }

        const confirmURL = 'http://localhost:8080/email/attachment/' + data.id + "/confirm"
        const responseConfirm = await fetch(confirmURL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Session': session
          }
        });

        session = responseConfirm.headers.get('session');

        if (!responseConfirm.ok) {
          console.log(responseConfirm)
          return
        }

        console.log("attachment sent successfully")
      } catch (error) {
        console.log(error)
      }

    }
  </script>
</body>

</html>

